---
title: "日々の運用監視からアプリケーションの状態を把握する重要性について"
weight: 100
date: 2999-01-24
description: "アプリケーションを作成した後の運用監視は欠かせませんが、重要性の認識や具体的な手法についての手法についてご紹介します。"
authors: [
["Kazunori Hamamoto","images/author/khamamoto.jpg"],
]
type : "article"
tags: ["general"]
eyecatch: "images/eyecatch/monitoring.png"
---

## はじめに

この記事では弊社が開発したアプリケーションを日々どのように運用しているのかご紹介したいと思います。この記事を読んでくださる方には様々な方がいらっしゃると思いますが、エンジニア以外の方にも運用と監視について目を向ける機会になればと思います。

## 運用と監視について

運用監視といったワードが一般的に広まっていますが、本来であれば運用と監視は別のワードですが。運用と監視はセットで行う事が通例となっているのが現状です。

運用と監視は互いに補完しあうものだと思っています。運用だけでは作りっぱなしのシステムとなってしまいますし、監視だけ行っても適切なフィードバックを行わなければ測定しているだけであり何も進展はありません。システム構築を行う際、制作するシステムの種類に問わず監視設定を行う事は多いかと思います。その際に運用にフィードバックする方法を検討しないと監視する事が目的になってしまいます。**運用と監視は目的ではなくアプリケーションをより良い方向へ成長させるための手段**だと思います。

## 監視で何を視るのか

ここで本来の**監視**の意味を振り返ってみよう。参考：[フリー百科事典『ウィキペディア（Wikipedia）](https://ja.wikipedia.org/wiki/%E7%9B%A3%E8%A6%96)

> 監視とは相手の状態や状況の変化を逐次に知るために見張りなどの手段を用いた受動的な情報収集の活動を言う。

相手とは対象のシステムの事であり、アプリケーションやインフラも含めて全てだと考えて問題ないでしょう。監視というワードが注目されるのは、主に障害が発生した時が多いです。障害が発生した際に「なぜ発生したのか」「どこから発生したのか」など原因分析する際に監視対象の項目から分析することは容易に想像できるかと思います。

しかし、障害が発生した状態を火事に例えると、すでに火の手があがっており燃えている状態です。本来ならば火の手があがる前に鎮火。または、そもそも火があがらないように予防することが適切な対処方法でしょう。

システム監視の場合も同様で、火の手があがる前に対処する事が重要であり、そのためには普段の状態を知っておく必要です。正常稼働している状態を日々、計測して認識することで異常な状態を知ることができ、いち早く対策することが監視という行為本来の目的なのではないかと思う。

### 監視対象

では何を監視対象とすれば良いのだろうか、弊社の監視対象を大まかに整理すると以下のようになっている。

- 各種メトリクス
  - CPU、Memory、DTU、SQLServerの容量
- 各種ログ
  - IISログ
  - クエリログ
  - アプリケーションログ


## 参考

- 監視

- 運用と監視について
  - 運用と監視の関係
    - 運用と監視は目的ではなく手段。
- 監視の必要性
  - 異常系の監視
    - アタックや想定外のエラーにより動かなくなっている事を察知するために必要
  - 正常系の監視
    - アプリケーションが正常に動いていることを測定するために監視が必要
- 監視の対象
  - メトリック
    - CPU,Memory、DTU、SQLServerの容量
  - システムログ
    - IISログ
  - クエリログ
    - SQLクエリのログ（EF）
  - アプリケーションログ
    - TraceLog、正常系、異常系のメッセージ
- 監視の種類
  - 内部の監視
    - 自分たちが作成したもの、WebAppのアプリケーション、SQLServer、キュー、自分たちが作成したAPI
  - 外部の監視
    - 連携先の正常性（SendGrid、Eコマースの基幹システム、決済プロバイダ）
- Azureを利用した監視
  - Application Insights
    - トレースログ、外部へのリクエスト、アプリケーションの例外、SQLクエリログ
  - Azure Monitor
    - メトリック（CPU,メモリ、ロードアベレージ、DTU）
  - Log Analytics
    - KQLの紹介
      - 結合のテクニック紹介
      - 例外のログにアプリケーションログやリクエストログを結合したりできる
  - EventGrid
    - Blobの監視に使える。（正常にファイルが作成された とか 相手から正常にファイルをもらえているとか）
  - 蛎殻町の監視システム
    - AzureDevOpsを使って標準的な監視を行うAzureFunctionを簡単デプロイできるようにしている。
- 監視を運用する
  - 監視対象の見直し
    - 日常的にアラートが上がる場合は閾値の変更
  - 監視項目の変更
    - 監視対象メトリックや項目の見直し、頻繁に発生する例外（FunctionのHostエラー）の除外
  - 通知方法の最適化
    - Mail => Slack
    - 見やすい形式の見せ方
      - 日付
      - どのアプリケーション
      - どこ？ APIサーバー Webサーバー
        - DLLとか
  - 監視はリスク管理
    - 監視をしていると日頃から、予兆がある
      - 定期的にスパイクしている
- 課題
  - エラーが起きた場合の自動復旧をしたほうがよいのか？
    - 自動復旧が可能なアーキテクチャになっているのか？
  - 各テナントで監視するのではなく、統合監視をするべき？
    - 統合管理ポータルを利用する？
  - テナント間で監視のレベル感が違う
  - アラートが出た後の解決フロー
    - 誰かが善意で動いている
  - リリース後の性能低下に気が付きにくい
    - エラー監視しかできていない
  - インシデントが顧客発生になりがち
    - 事前に弊社で気づけると良い
      - 正常系の監視目を向けるべき
- Topic
  - SREとは。。。

# 伝えたいこと
- ↓変ると思う
- 監視は運用の手段であること
  - 監視システムを作るのは目的ではない。
- 異常が起きた事を監視するのではなく、システムが正常に動いている事を運用監視する
- 監視もシステムとして適切にチューニングするべき
  - 日常のアラートがですぎて、稀に発生する重大なアラートを見逃さないようにする事が重要
