---
title: "Azure非機能要について考える"
weight: 10
date: 2020-08-31
description: "Azureの非機能要件についてです。"
authors: [
["Keiichi Hashimoto","images/author/k1hash.png"]
]
type : "article"
tags: ["Azure"]
eyecatch: "/images/eyecatch/default.png"
draft : "true"
---

## そもそも非機能要件とは何か

- NFR Non Functional Requirement
- 可用性、性能・拡張性、運用・保守性、移行性、セキュリティ、システム環境エコロジー
- IPA https://www.ipa.go.jp/sec/softwareengineering/std/ent03-b.html
- IPA 2018年に更新
- JUAS https://juas.or.jp/library/books/445011/
- JUAS ユーザービリティ、効果性などを考慮
- 全て明確に定義する必要はないが、重要な要件漏れとか想定違いを防ぐ
- パブリッククラウドが当たり前となって、検討視点も変わってきていると思い今回議論する

## パブリッククラウドにおける非機能要件の進め方

- スタート地点がAzureの基本的な特性を理解すること
- 基本情報、アベイラビリティゾーン、ペアのリージョン
- マネージドサービスはサービスについては、基本Microsoftが管理している
- マネージドサービスはサービス仕様で非機能要件が備わっていたり変えられない部分がある
- 例えば、インスタンス自体を意識するものと、しないものがある
- 例えば、データが自動で３重化されているものがある
- コストに関係ない部分はベストプラクティスを選択する事が望ましい
- ベストプラクティスの後に選択肢を検討（例えば東西のDRとか）
- あと実装で非機能要件を叶える方法がある(サービスの組み合わせやデザインパターン)

## Azureの基本的な特性

### Azure のリージョンと Availability Zones

#### リージョン

- リージョン
- https://azure.microsoft.com/ja-jp/global-infrastructure/geographies/
- リージョン毎に無いサービスもある

#### 代替リージョン

- 東日本と西日本のペア
- DR対策用で、Availability Zone をサポートするものではない。
- Geo レプリケーションの対象となる(ゾーン冗長ストレージ、SQL Database)

#### Availability Zones(アベイラビリティゾーン、可用性ゾーン)

https://docs.microsoft.com/ja-jp/azure/availability-zones/az-overview

- Availability Zones アベイラビリティゾーン East Japanでも物理的に３か所以上。
- アベイラビリティゾーン＝建屋が違う、内部ネットワークが違う、筐体が違う。
- 回復性を確保するため、有効になっているリージョンにはいずれも最低 3 つのゾーンが別個に存在しています。
- 障害ドメインと更新ドメインを組み合わせたものです。 たとえば、Azure リージョンの 3 つのゾーンに 3 つ以上の VM を作成する場合、VM は実際には 3 つの障害ドメインと 3 つの更新ドメインに分散されます。

### ゾーンサービスとゾーン冗長サービス

- ゾーン サービス – 特定のゾーン (たとえば、仮想マシン、マネージド ディスク、標準の IP アドレス) にリソースがピンされます。
- ゾーン冗長サービス – Azure プラットフォームが複数のゾーンにわたって
- 自動的にレプリケートされる場合 (ゾーン冗長ストレージ、SQL Database など) はこちらです。

## Azureにおける基本的な冗長化

- 冗長化の目的は単一障害点を回避すること。
- 種別としては、マネージドサービスか自分で管理する必要のあるサービス。
- マネージドサービスでもMicrosoftが仕様として冗長化しているサービス、インスタンスの考慮自体が不要なもの。
- 地理冗長しても、サービスがどのように持続できるかは様々な制限がある。
- 地理冗長については、そもそもどういった持続要求があるのかから検討が必要。

### マネージドサービスでインスタンスの冗長化が既にされているもの

- 既に冗長化されているサービスの仕様を知る。
- SQL Database 三重化されている。
- Storage  三重化されている。

### マネージドサービスでインスタンスの考慮が不要なもの

- Event Grid
- Functions (App Service Plan内で動かした場合除く)
- Azure Load Balancer
- Azure CDN

### マネージドサービスでインスタンス数の考慮が必要なもの

- App Service ＝App Service プランを利用する。
- App Service のインスタンスは障害時に自動リカバリーされるが複数インスタンスで可用性を上げる。
- Application Gateway＝V2でユニットになった。※モヤっとしているので要調査。
- Functions ＝AppServiceで起動しているもの。

### マネージドサービスではないので、自分で冗長化の考慮が必要

- VM=可用性セット

## Azureにおける基本的な復旧

### マネージドサービス

- Microsoftが運用自体をコントロールしている。
- サービスとしては自動復旧が基本。

#### データベースの復旧(Microsoftの仕様)

- SQL Database  PITR　SQLDBもっと短い※もう少し、 MySQL＝5分単位
- 最大35日分
- SQL Database＝Geoリストア5分

#### Webサーバーの復旧

- App Serviceのトラブルの場合、Azureが新しいインスタンスを作ってくれる。

#### マネージドサービスかつインスタンスの考慮が不要なサービス

- 自動でMicrosoftが復旧する。サービスとしての復旧を待つしかない。

#### マネージドサービスではない

- VMは自分で復旧させることが必要。

### SLAホーム

- SLAホームに詳しく載っているが、システムは結局幾つかのサービスが繋がって構成されているので、個々に検討しても意味は薄い。
- 99.99のものを直列に並べると基本的には下がっていく。
- 逆にうまい形で横に並べると稼働率は上がる。
- 後は、SLAが提供されていないサービスとしてBasicのロードバランサーを選ばない。等の選択肢となる。

- この数字は過信してはならない。インフラが動く時間とあなたのアプリケーションが同率で動くというわけではない。
- 自分達のサービスの稼働率をきちんと正しく算出できるようになりましょう。

- SLAホーム https://azure.microsoft.com/ja-jp/support/legal/sla/
- ストレージのSLA ローカルLRSだと99.9 ゾーン冗長の読み取りだと 99.99
- https://azure.microsoft.com/ja-jp/support/legal/sla/storage/v1_5/
- App Service 99.95
- https://azure.microsoft.com/ja-jp/support/legal/sla/app-service/v1_4/
- Cosmos DB 99.999
- https://azure.microsoft.com/ja-jp/support/legal/sla/cosmos-db/v1_3/
- Azure SQL Database
- ゾーン冗長(プレミアム)　99.995
- ゾーン冗長ではない　99.99
- ジオレプリケーション　5秒間の目標回復ポイントRTO　30秒間の目標回復時間RPO
- Azure Database for MySQL 99.99
- 年間で止まる時間
- 99.9＝8.76時間  Azure Storage(LRS,ZRS)
- 99.95=4.38時間　App Service
- 99.99＝52.6分     Azure SQL Database, Azure Storage(GRS)
- 99.995=26分     Azure SQL Database(ゾーン冗長)
- 99.999＝5.26分     Cosmos DB

### 上限値

https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/management/azure-subscription-service-limits

- VMやApp Service のインスタンススペック
- SQL Database のDTUや容量などスペック
- Storage の容量
- Application Insights のログ保持期間
- 帯域等

### ネットワーク

- イントラネットや外部システムとのネットワーク接続
- 帯域★どんな点に注意してます？
- ネットワーク(サブネット)でどれだけ＝十分ある
- あります！浅見が言った。
- CommerbleはBシリーズで上限に当たる。
- SNMP
- 仮想マシンの帯域、
- AppServiceの帯域＝なさげ
- Express Route の帯域＝価格にかなり影響
- 細かい話＝どういう風に通信、Azureからオンプレ経由で全部など
- きちんと詰める話が多い

- VNET★どんな点に注意してます？
- ほとんど組む、ServiceEndpointを使うので。
- ベストプラクティスなので採用(外を通さない)
- AppService間の通信＝VNET統合、別リージョンに行けない
- 経路
- WFHだとVNETの中に入れてても良いの？出社しないと触れない系
- むしろRBACとかが増えている
- Bastion→VM(JIT)
- 出ていくパケットを制限したい(WVDから特定のサイトに行けないようにする)
- AppServiceで外部のサードパーティーAPIのみに許可する
- Azure Firewall はApp Service から通せない
- バラクータ、パロアルト
- Azure Web Proxy が欲しい＝OutBoundのプロキシがあると捗る
- Squidとかでやる
- マネージドサービスはVNETに入るものと入らないものがある。
- マネージドサービスは接続制限が可能なものと不可能なものがある。
- App Service を単独ホスティングしたい＝ASEの利用有無を検討する。

### 運用監視

- Azure Monitor(Application Insights, Log Analytics)
- Azure のPaaSを監視しよう＝Azure Monitorとなる
- New Relic どうなった？普通に使える
- App Service と仮想マシンだと New Relicも
- SQL Database, IoT Hub,Cosmos の監視＝サードパーティーのツール使えない
- サードパーティーのMonitorはAzure Monitor
- インターフェース何が良い？結局 Azure Monitor に繋ぐけど。
- いつものツール使いたい要望＝ツールが変わるとミスが増える
- ミスが少なく学習コストを低く＝既存のツールをインターフェースとして
- 診断ログ＝EventHub→外部のツール(Logic Appsのコネクタで投げる？)
- 診断ログを受け側で見れるようにしたい＝W3Cで汎用？
- Azure Monitor＝保存先、Storageにも置ける＝外部連携
- システムセンターとかとも連携

- OSを監視するケースは少ない(★VM利用時くらい？)
- App Service のプロセス監視したい＝Zabbixエージェントとか
- 過去からの監視リストが脈々と
- システム特性による値の監視。
- 連携先外部システムのエラーなど。
- バッチ＝Functions等リトライが組める場合は組む、その後の業務フローを定義する必要がある。

### セキュリティ(一部)

- 監査＝SQL Database、Storage？Cosmos？
- 暗号化＝SQL Database(透過的暗号化、行、列)、Storage？★Cosmos？
- WAF=Application Gateway か　Front Door を使う
- アンチマルウェア＝VM利用時のみ　マネージドサービス利用時にある？
- パッチ＝マネージドである場合、MS側での適用となる？どう説明している？
- 接続文字列などの暗号化＝Key Vault、暗号化
- セキュリティセンターの活用
- 他にセキュリティの観点で話すこと　ADとか？

### アカウント管理

- Azure のアカウントと権限★よくある管理形態とか、があります？
- サブスクリプション
- 本番とステージングでサブスクリプションを分ける
- 支払い方法★非機能要件項目にはないけど、必要そう
- 費用上限の設定、通知★同上

================================================

## 非機能要件

- 上述の通り、Azureの場合は、サービスの仕様として既に非機能要件を満たす仕様を備えているものがある。
- Azure の場合は同様に、サービスの仕様として変えられないものもある。
- Azureの場合は、コスト上そこまで大きく変わらずにベストプラクティスを採用することができる
- ので、ヒアリングしてどうこうの前にベストプラクティスを選択するのが望ましいとは思う
- この段階で、ヒアリングを行い、摺合せしていく

## 顧客に何を聞かなくてはいけないか？

ここからは、非機能要件に関する有効な質問を検討する

## システム特性

- どのような利用があるシステムか、利用者数、時間帯、
- 負荷＝特性、時刻、シーズン、計画的か突発か
- ネットワーク帯域、専用線のネットワーク帯域(Express Routeの帯域)
- データ量、トランザクション量
- 業界基準(PCI DSS、HIPPA)
- システム停止時の経済的損失、報告先
- DRをどう考えるか
- Azureに対する予算、現状の予算との比較
- 運用も込みで考えるのがパブリッククラウド
- 何％がAzure費用で何％が運用監視＝オンプレと全然違うはず
- その中でどうやって儲けを出すか＝SIerの場合
- 結果トータル安くなる、減価償却
- 売上とかコスト削減による利益も含めてDevOps＝収益を上げる場所を
- 人件費も含めた運用コスト＝運用の人件費が下がるはず

### 思うに

- パブリッククラウドにはコストの軸が必要
- 運用管理の非機能要件定義が必要(タスク管理、)

## 可用性　Availability

### 継続性

#### 運用スケジュール

- システムの稼働時間や停止運用に関する情報、計画停止
- 業務時間　夜間停止　24時間無停止★ECの場合だいたいこれ
- Azureの可用性　WebApps99.95　SQLDB　CosmosDB

#### 業務継続性

- 対象業務範囲、サービス切替時
- サービス切替＝Azureだと自動(WebApps、SQLDBの三重化、Storageも気付かない)
- 障害時の業務停止を許容しない＝DR＝WebApps、SQLDB
- マルチリージョンはちゃんと出来ているケースが少ない

#### 目標復旧水準

- 何をどこまで、どのくらいで復旧させるか。
- Azureのマネージドサービスの障害停止はMSに任せる(トランザクション＝コントロールできない)
- 復旧後の正常性確認が利用者の仕事となる。

#### 大規模災害復旧時

- どのくらいで復旧するか（１日、３日、１週間、一か月） 
- DR構成＝Geoレプリケーション(データベース、ストレージ)　待機系の構築
- DRに対応 Cosmos DB(マルチリージョン 99.999%)

#### 稼働率

- 単体ではなく、連携して動いている、直列だと下がる
- 自分たちのサービスの稼働率を正しく算出できるようにする
- うまい形でインフラ組むと稼働率が上がる
- SLAのためにスタンダードを契約する
- 所詮返金規則である
- 都合悪い時に泊まってもビジネスの継続性をちゃんと把握できる

#### 耐障害性

### サーバー

#### 冗長化

- マネージドなサービスであれば基本冗長化されている
- App Service SQL Database Storage Functions CosmosDB FrontDoor ?
- 基本App Serviceはイミュータブル　永続化データはない
- Virtual Machine であれば永続化データがあるかもしれないが、極力そのような設計はしない
- Virtual Machine であれば冗長化の検討が必要とAzure Disk 使う？

#### 端末

- 端末の冗長化とは？
- 踏み台マシンもマネージド(Bastion)

### ネットワーク機器

- 大半がマネージドなので、冗長化する必要がないのでは？
- 非機能要件的に考慮不要なのか、制約を伝えるべきなのか？

### ストレージ

- 冗長化されている、LRFSとか、リージョン間の冗長化とか、自分でフェイルオーバーを選択するとか

### データ

#### データ復旧方式

- SQL Database=オンラインバックアップ、三重化
- CosmosDB=?
-  
- 仮想マシンで組む場合はディスクのバックアップ？

#### データ復旧範囲

- ソースコードやデプロイ＝基本イミュータブル、CI/CD、GitHub、Azure Devopsにて管理
- Storage＝地理上長の場合、自分でフェイルオーバーする選択肢がある
- Storage=論理削除の機能はあるので、ミスによる復旧は可能？
- SQL Database=5分単位、2週間前まで？
- CosmosDB=?

## 災害対策

### システム

- DRサイトで限定した構成、DRサイトで同一の構成
- FrontDoorでやる？Traffic Managerどうなったっけ？

### 外部保管データ

- Storage地理上長を設定可能
- 付帯設備＝Azureで議論することある？

### 復旧作業＝MSがやること、自分でやること

- 正直、データの復旧をオペミス以外に手動で行うことはないのでは？
- DBの特定のデータ復旧であればPITRから可能

## 性能拡張性 Scalability

## 業務処理量

### 通常時の業務処理量

#### ユーザー数

- 特定、不特定多数＝不特定多数の場合、多層で検討が必要になる
- FrontDoor,CDN,Application Gateway
- WebAppsのインスタンス数、Function(プレミアム、従量課金)
- SQL Database, CosmosDB
- Redis, CDN, APIManagement
- 同時アクセス数
- データ量
- オンラインリクエスト件数
- バッチ処理件数
- 業務機能数

### 業務量増大度

- ユーザー数の増率、同時アクセス数の増率、データ量の増率、オンラインリクエスト件数、
- バッチ処理件数、業務機能数

### 保管期間

- OS、ミドルウェアのログの保存期間、6か月から、10年、永久保管
- 対象範囲(アーカイブ有無)

### オンラインレスポンス

### バッチレスポンス

### オンラインスループット

### バッチスループット

### 帳票印刷能力

## リソース拡張性

### CPU拡張性

- 拡張目安のCPI利用率
- 何倍まで拡張可能か

### メモリ拡張性

- メモリ利用率
- メモリ拡張性

### ディスク拡張性

- ディスク利用率
- ディスク拡張性

### ネットワーク拡張性

-

### サーバー処理能力

- スケールアップ＝基本的に可能、不可能なサービス？
- スケールアウト＝基本的に可能、不可能なサービス？

## 性能品質保証

### 帯域保証機能

- プロトコル単位、サーバー毎、エンドツーエンドで
- Azureだとどこまで保証されるかサービス毎に確認が必要
- 情報はどこ？

### HWリソース占有の有無

- WebAppsならASEの検討

### 性能テスト

- ライフサイクルにおける性能テスト(稼働開始から稼働後)
- 確認範囲

### スパイク負荷対応

- トランザクション保護、制限、Sorry、独立したSorry

## 運用・保守性

### 通常運用

#### 運用時間

- 通常日＝停止可能時間、24時間無停止
- 特定日

#### バックアップ

- 一部、全部
- ソースコード、ログ、永続化データ
- 自動化
- 取得間隔、保存期間

#### 運用監視

- 監視情報＝監視情報は基本的にAplication Ingiht
- 監視間隔＝？
- システムレベルの監視＝ハードウェア、OS層のトラブルはMS、
- プロセスレベルの監視＝プロセスのトラブルは？
- データベースの監視＝MS、CPU利用率とメモリ利用率などパフォーマンスは監視
- ストレージの監視＝死活監視はMS
- サーバーの監視＝自動、閾値のセット可能
- ネットワークのパケットレベルの監視＝★できない？

### 時刻同期

- ユーザー側で対応することはできない？

## 保守運用

### 計画停止

- 計画停止の有無、Azureはほぼない
- のでアプリケーションの都合となる
- 事前アナウンス＝特定サービスのディスコンはあるような

### 保守作業の自動化

- AzureだいたいMS任せるになるし、ハードウェア移動することもある
- インスタンスガチャある？
- サーバーソフトウェアの更新作業＝MS
- 端末ソフトウェアの更新作業＝端末ある？
- パッチリリース＝MSが随時であってる？
- パッチ適用方針＝これ何かある？
- パッチ適用タイミング＝随時
- パッチ検証＝できない、お任せであってる？

### 活性保守

- 定期保守＝ない
- 定期保守頻度＝ない
- 予防保守＝ない

## 障害時運用

### 復旧作業

- 必要な労力＝決済とか、データの正常化とか業務による
- 代替業務
- 復旧自動化(バッチはキューで？)他★ 

### システム異常検知時の対応

- 対応可能時間(★夜間はプレミアが必要？)
- 夜間USに問い合わせをするのは可能？
- 到着時間＝あまり問題ではない

### 交換用部材

- 議論対象ではない

## 運用環境

### 開発環境、試験環境の設置

- サブスクリプション分けた方が良い

### マニュアル準備

- Azureに関するマニュアルだとすると画面が常に進化するので適していないと思う

## サポート体制

### ハードウェア検討不要

### 保守ソフトウェア

### ライフサイクル期間

- これどう考えたらいいんだろう？★面白い
- ロードマップ見るべきとか？

### メンテナンス作業役割分担

### 一次対応＝CSP、どうやっとるんだろ

## その他運用管理方針

### 内部統制対応

- セキュリティセンターが有能なので検討
- インシデント管理(Azureのインシデント管理ルール)
- 変更管理＝DevOpsが良いのでは
- リリース管理＝CI/CD　でDevOpsが良い

## 移行

- 何か話すことある？

## セキュリティ
### コンプライアンス

- 遵守すべきもの、セキュリティセンター
- 脅威分析、これもセキュリティセンター？
- 脆弱性診断

### セキュリティリスク見直し

- パッチ適用＝MS
- 自分で当てたいなんてケースないよね

# どこいった

- VNETなどネットワーク要件

# 結論

やっぱりAzureが大好き、Azureのおかげで少人数でも大きいビジネスを回すことができる
